@model ElOlivo.Models.usuario
@using Microsoft.AspNetCore.Http
@{
    Layout = "_Layout_Usuario";
    ViewData["Title"] = "Editar Perfil";

    // Cargar lista de países desde ViewBag
    var paises = ViewBag.Paises as List<SelectListItem> ?? new List<SelectListItem>();
    var tieneFoto = !string.IsNullOrEmpty(Model.foto_url);
}

<style>
    :root {
        --primary-green: #2e7d32;
        --secondary-green: #4caf50;
        --light-green: #e8f5e9;
        --dark-green: #1b5e20;
        --accent-green: #81c784;
        --text-dark: #1e3a1f;
        --text-light: #4a6b4b;
        --border-green: #a5d6a7;
        --success-green: #388e3c;
        --warning-amber: #f57c00;
    }

    .dashboard-header {
        background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
    }

    .dashboard-title {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }

    .dashboard-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0;
    }

    .tasks-section {
        background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);
        border: 2px solid var(--border-green);
        border-radius: 16px;
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.15);
        overflow: hidden;
    }

    .section-header {
        background: linear-gradient(135deg, var(--secondary-green) 0%, var(--primary-green) 100%);
        padding: 1.5rem 2.5rem;
        color: white;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .profile-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-green);
        box-shadow: 0 2px 8px rgba(129, 199, 132, 0.1);
    }

    .profile-section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--dark-green);
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--light-green);
        display: flex;
        align-items: center;
    }

    .profile-field {
        margin-bottom: 1.5rem;
    }

    .profile-label {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        font-size: 0.95rem;
    }

    .profile-input {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #fafdfa;
    }

        .profile-input:focus {
            border-color: var(--secondary-green);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            background: white;
        }

        .profile-input.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

    .validation-error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    .avatar-container {
        position: relative;
        display: inline-block;
    }

    .avatar-image {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border: 4px solid var(--secondary-green);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        transition: all 0.3s ease;
    }

        .avatar-image:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

    .avatar-placeholder {
        width: 150px;
        height: 150px;
        background: var(--light-green);
        border: 3px dashed var(--border-green);
        color: var(--secondary-green);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--secondary-green) 0%, var(--primary-green) 100%);
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
        }

    .btn-secondary {
        background: white;
        border: 2px solid var(--border-green);
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        color: var(--text-dark);
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

        .btn-secondary:hover {
            background: var(--light-green);
            border-color: var(--secondary-green);
            color: var(--dark-green);
            transform: translateY(-1px);
        }

    .btn-outline-primary {
        border: 2px solid var(--secondary-green);
        color: var(--secondary-green);
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

        .btn-outline-primary:hover {
            background: var(--secondary-green);
            color: white;
            transform: translateY(-1px);
        }

    .alert {
        border-radius: 10px;
        border: none;
        padding: 1.25rem;
        margin-bottom: 2rem;
    }

    .alert-danger {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        color: #c62828;
        border-left: 4px solid #f44336;
    }

    .profile-actions {
        background: white;
        padding: 1.5rem 2rem;
        border-top: 2px solid var(--light-green);
        border-radius: 0 0 12px 12px;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        align-items: center;
    }

    .form-text {
        color: var(--text-light) !important;
        font-size: 0.85rem;
    }

    select.profile-input {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%232e7d32' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
    }
</style>
<div class="tasks-section">
    <div class="section-header">
        <h2 class="section-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Editar Información Personal
        </h2>
    </div>

    <div style="padding: 2rem 2.5rem;">
        <form asp-action="EditarPerfil" method="post" class="profile-form" enctype="multipart/form-data">
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger">
                    <h5 style="color: #c62828; margin-bottom: 1rem;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Por favor, corrige los siguientes errores:
                    </h5>
                    <ul style="margin: 0; padding-left: 1.5rem;">
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    </ul>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <div class="row g-4">
                <!-- Columna Izquierda - Foto de Perfil -->
                <div class="col-lg-4">
                    <div class="profile-section">
                        <h3 class="profile-section-title">
                            <i class="fas fa-camera" style="color: var(--secondary-green); margin-right: 0.5rem;"></i>
                            Foto de Perfil
                        </h3>

                        <div class="text-center mb-4">
                            <div class="avatar-container">
                                @if (tieneFoto)
                                {
                                    <img id="avatarPreview" src="@Model.foto_url" alt="Foto de perfil"
                                         class="avatar-image rounded-circle">
                                }
                                else
                                {
                                    <div id="avatarPreview" class="avatar-placeholder rounded-circle d-flex align-items-center justify-content-center"
                                         style="margin: 0 auto;">
                                        <i class="fas fa-user fa-3x" style="color: var(--secondary-green);"></i>
                                    </div>
                                }
                            </div>

                            <div class="mt-3">
                                <label for="archivoFoto" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-upload me-1"></i>
                                    Seleccionar Foto
                                </label>
                                <input type="file" id="archivoFoto" name="archivoFoto"
                                       accept=".jpg,.jpeg,.png,.gif" style="display: none;"
                                       onchange="previewImage(this)">
                            </div>

                            <small class="form-text text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Formatos: JPG, JPEG, PNG, GIF<br>
                                Máximo: 5MB
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha - Información Personal -->
                <div class="col-lg-8">
                    <div class="row">
                        <div class="col-12">
                            <div class="profile-section">
                                <h3 class="profile-section-title">
                                    <i class="fas fa-user" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
                                    Información Personal
                                </h3>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="profile-field">
                                            <label asp-for="nombre" class="profile-label">
                                                <i class="fas fa-signature" style="margin-right: 0.5rem; color: var(--primary-green);"></i>
                                                Nombre *
                                            </label>
                                            <input asp-for="nombre" class="form-control profile-input @(ViewData.ModelState["nombre"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                                   placeholder="Ingresa tu nombre (solo letras)" />
                                            <span asp-validation-for="nombre" class="validation-error"></span>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="profile-field">
                                            <label asp-for="apellido" class="profile-label">
                                                <i class="fas fa-signature" style="margin-right: 0.5rem; color: var(--primary-green);"></i>
                                                Apellido *
                                            </label>
                                            <input asp-for="apellido" class="form-control profile-input @(ViewData.ModelState["apellido"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                                   placeholder="Ingresa tu apellido (solo letras)" />
                                            <span asp-validation-for="apellido" class="validation-error"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="profile-field">
                                    <label asp-for="email" class="profile-label">
                                        <i class="fas fa-envelope" style="margin-right: 0.5rem; color: var(--primary-green);"></i>
                                        Correo Electrónico *
                                    </label>
                                    <input asp-for="email" type="email" class="form-control profile-input @(ViewData.ModelState["email"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                           placeholder="ejemplo@correo.com" />
                                    <span asp-validation-for="email" class="validation-error"></span>
                                </div>

                                <div class="profile-field">
                                    <label asp-for="telefono" class="profile-label">
                                        <i class="fas fa-phone" style="margin-right: 0.5rem; color: var(--primary-green);"></i>
                                        Teléfono
                                    </label>
                                    <input asp-for="telefono" type="tel" class="form-control profile-input @(ViewData.ModelState["telefono"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                           placeholder="XXXX-XXXX" />
                                    <span asp-validation-for="telefono" class="validation-error"></span>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Formato: XXXX-XXXX (ej: 1234-5678)
                                    </small>
                                </div>

                                <div class="profile-field">
                                    <label asp-for="pais" class="profile-label">
                                        <i class="fas fa-globe" style="margin-right: 0.5rem; color: var(--primary-green);"></i>
                                        País *
                                    </label>
                                    <select asp-for="pais" class="form-control profile-input @(ViewData.ModelState["pais"]?.Errors.Count > 0 ? "is-invalid" : "")">
                                        @foreach (var pais in paises)
                                        {
                                            <option value="@pais.Value" selected="@pais.Selected">@pais.Text</option>
                                        }
                                    </select>
                                    <span asp-validation-for="pais" class="validation-error"></span>
                                </div>

                                <div class="profile-field">
                                    <label asp-for="institucion" class="profile-label">
                                        <i class="fas fa-university" style="margin-right: 0.5rem; color: var(--primary-green);"></i>
                                        Institución
                                    </label>
                                    <input asp-for="institucion" class="form-control profile-input @(ViewData.ModelState["institucion"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                           placeholder="Nombre de tu institución" />
                                    <span asp-validation-for="institucion" class="validation-error"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="profile-actions mt-4">
                <div class="action-buttons">
                    <a href="@Url.Action("MiPerfil")" class="btn-secondary">
                        <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                        Cancelar
                    </a>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save" style="margin-right: 0.5rem;"></i>
                        Guardar Cambios
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Previsualización de imagen
        function previewImage(input) {
            const preview = document.getElementById('avatarPreview');
            const file = input.files[0];

            if (file) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    if (preview.tagName === 'IMG') {
                        preview.src = e.target.result;
                    } else {
                        // Convertir el placeholder a imagen
                        const newPreview = document.createElement('img');
                        newPreview.id = 'avatarPreview';
                        newPreview.src = e.target.result;
                        newPreview.alt = 'Foto de perfil';
                        newPreview.className = 'avatar-image rounded-circle';

                        preview.parentNode.replaceChild(newPreview, preview);
                    }
                }

                reader.readAsDataURL(file);
            }
        }

        // Validación en tiempo real para nombre y apellido
        document.addEventListener('DOMContentLoaded', function () {
            const nombreInput = document.getElementById('nombre');
            const apellidoInput = document.getElementById('apellido');
            const telefonoInput = document.getElementById('telefono');

            function validarSoloLetras(input) {
                input.addEventListener('input', function () {
                    this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
                });
            }

            if (telefonoInput) {
                telefonoInput.addEventListener('input', function () {
                    this.value = this.value.replace(/[^\d-]/g, '');

                    if (this.value.length === 4 && !this.value.includes('-')) {
                        this.value = this.value + '-';
                    }
                });
            }

            if (nombreInput) validarSoloLetras(nombreInput);
            if (apellidoInput) validarSoloLetras(apellidoInput);

            // Trigger file input when clicking the button
            document.getElementById('archivoFoto').addEventListener('change', function () {
                previewImage(this);
            });
        });
    </script>
}

