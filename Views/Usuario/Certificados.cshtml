@* Views/Usuario/Certificados.cshtml *@
<link rel="stylesheet" href="~/css/Tablas.css" />

@model IEnumerable<dynamic>

@{
    Layout = "_Layout_Usuario";
    ViewData["Title"] = "Mis Certificados";
}

<h2 class="page-title">Mis Certificados</h2>

<!-- Filtros -->
<div class="filtros-card">
    <form asp-action="Certificados" method="get" class="filtros-form">
        <div class="filtros-grid">
            <!-- Buscar -->
            <div class="filtro-item">
                <label class="filtro-label">Buscar certificado</label>
                <input type="text" name="search" placeholder="Código, evento o sesión..."
                       value="@Context.Request.Query["search"]" class="busqueda-input" />
            </div>

            <!-- Estado -->
            <div class="filtro-item">
                <label class="filtro-label">Estado</label>
                <select name="estado" class="busqueda-input">
                    <option value="">-- Estado --</option>
                    <option value="7" selected="@(Context.Request.Query["estado"] == "7")">En proceso</option>
                    <option value="8" selected="@(Context.Request.Query["estado"] == "8")">Emitido</option>
                    <option value="9" selected="@(Context.Request.Query["estado"] == "9")">Cancelado</option>
                </select>
            </div>

            <!-- Fecha emisión inicio -->
            <div class="filtro-item">
                <label class="filtro-label">Fecha desde</label>
                <input type="date" name="fechaInicio"
                       value="@Context.Request.Query["fechaInicio"]" class="busqueda-input" />
            </div>

            <!-- Fecha emisión fin -->
            <div class="filtro-item">
                <label class="filtro-label">Fecha hasta</label>
                <input type="date" name="fechaFin"
                       value="@Context.Request.Query["fechaFin"]" class="busqueda-input" />
            </div>

            <!-- Botones -->
            <div class="botones-filtro">
                <button type="submit" class="btn btn-success">Buscar</button>
                <button type="submit" class="btn btn-danger" name="limpiar" value="true">Limpiar</button>
            </div>
        </div>
    </form>
</div>

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info">No tienes certificados registrados.</div>
}
else
{
    <div class="eventos-container">
        <!-- Encabezado -->
        <div class="eventos-header">
            <div class="eventos-header-item">Código Único</div>
            <div class="eventos-header-item">Evento</div>
            <div class="eventos-header-item">Sesión</div>
            <div class="eventos-header-item">Fecha Emisión</div>
            <div class="eventos-header-item">Estado</div>
            <div class="eventos-header-item">Acciones</div>
        </div>

        <!-- Tarjetas de Certificados -->
        @foreach (var certificado in Model)
        {
            <div class="evento-card">
                <!-- Código Único -->
                <div class="evento-item">
                    <span class="evento-item-label">Código Único</span>
                    <span class="evento-item-value evento-nombre">@certificado.codigo_unico</span>
                </div>

                <!-- Evento -->
                <div class="evento-item">
                    <span class="evento-item-label">Evento</span>
                    <span class="evento-item-value evento-descripcion">@certificado.EventoNombre</span>
                </div>

                <!-- Sesión -->
                <div class="evento-item">
                    <span class="evento-item-label">Sesión</span>
                    <span class="evento-item-value">@certificado.SesionTitulo</span>
                </div>

                <!-- Fecha Emisión -->
                <div class="evento-item">
                    <span class="evento-item-label">Fecha Emisión</span>
                    <span class="evento-item-value">
                        @if (certificado.FechaEmision != null)
                        {
                            @certificado.FechaEmision.ToString("dd/MM/yyyy")
                        }
                        else
                        {
                            <span class="text-muted">No emitido</span>
                        }
                    </span>
                </div>

                <!-- Estado -->
                <div class="evento-item">
                    <span class="evento-item-label">Estado</span>
                    <span class="estado-badge
                        @(certificado.EstadoId == 7 ? "estado-proceso" :
                          certificado.EstadoId == 8 ? "estado-emitido" : "estado-cancelado")">
                        @certificado.EstadoNombre
                    </span>
                </div>

				<div class="evento-acciones">
					<button type="button" class="btn btn-success">Detalles del Evento</button>
                    @if (certificado.EstadoId == 8)
                    {
                        <a asp-action="Certificado" asp-route-id="@certificado.certificadoid"
                           class="btn btn-primary btn-sm btn-certificado"
                           data-certificado-id="@certificado.certificadoid">
                            Descargar
                        </a>
                    }
                    else
                    {
                        <button type="button" class="btn btn-secondary btn-sm" disabled>
                            No disponible
                        </button>
                    }
                </div>
            </div>
        }
    </div>
    <div class="modal fade" id="certificadoModal" tabindex="-1" aria-labelledby="certificadoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="certificadoModalContent">
                <!-- El contenido se cargará aquí via AJAX -->
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Manejar clic en botones de certificado
        $(document).on('click', '.btn-certificado', function (e) {
            e.preventDefault();

            var btn = $(this);
            var url = btn.attr('href');
            var certificadoId = btn.data('certificado-id');

            console.log('Cargando certificado:', certificadoId);

            // Mostrar loading en el modal
            $('#certificadoModalContent').html(`
                        <div class="modal-header">
                            <h5 class="modal-title">Cargando certificado...</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando certificado, por favor espere...</p>
                        </div>
                    `);

            // Mostrar el modal
            var certificadoModal = new bootstrap.Modal(document.getElementById('certificadoModal'));
            certificadoModal.show();

            // Cargar el contenido del certificado via AJAX
            $.ajax({
                url: url,
                type: 'GET',
                success: function (data) {
                    console.log('Certificado cargado exitosamente');
                    $('#certificadoModalContent').html(data);
                },
                error: function (xhr, status, error) {
                    console.error('Error al cargar certificado:', error);
                    $('#certificadoModalContent').html(`
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title">Error</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-danger">
                                        <h5>Error al cargar el certificado</h5>
                                        <p>No se pudo cargar el certificado. Por favor, intente nuevamente.</p>
                                        <small>Error: ${error}</small>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                </div>
                            `);
                }
            });
        });

        // Cerrar modal cuando se hace click en Cancelar
        $(document).on('click', '[data-bs-dismiss="modal"]', function () {
            $('#certificadoModal').modal('hide');
        });
    </script>
}

<style>
    .estado-proceso {
        background-color: #fff3cd;
        color: #856404;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
    }

    .estado-emitido {
        background-color: #d1edff;
        color: #004085;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
    }

    .estado-cancelado {
        background-color: #f8d7da;
        color: #721c24;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
    }


</style>

